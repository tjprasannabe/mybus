<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Simple 3D Bus Driving</title>
<style>
  body { margin: 0; overflow: hidden; }
  canvas { display: block; }
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
<script>

let scene, camera, renderer;
let world, vehicleBody, vehicle;
let chassisMesh, wheelMeshes = [];
let clock = new THREE.Clock();

init();
animate();

function init() {
  // Scene setup
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x88ccee);

  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 5, 10);

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Cannon physics world
  world = new CANNON.World();
  world.gravity.set(0, -9.82, 0);

  // Ground
  let groundBody = new CANNON.Body({ mass: 0 });
  let groundShape = new CANNON.Plane();
  groundBody.addShape(groundShape);
  groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
  world.addBody(groundBody);

  let groundGeo = new THREE.PlaneGeometry(1000, 1000);
  let groundMat = new THREE.MeshPhongMaterial({ color: 0x006600 });
  let groundMesh = new THREE.Mesh(groundGeo, groundMat);
  groundMesh.rotation.x = -Math.PI / 2;
  scene.add(groundMesh);

  // Lights
  let hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
  hemiLight.position.set(0, 20, 0);
  scene.add(hemiLight);
  let dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
  dirLight.position.set(5, 10, 7);
  scene.add(dirLight);

  // Vehicle chassis
  let chassisShape = new CANNON.Box(new CANNON.Vec3(1, 0.5, 2));
  vehicleBody = new CANNON.Body({ mass: 150 });
  vehicleBody.addShape(chassisShape);
  vehicleBody.position.set(0, 1, 0);
  world.addBody(vehicleBody);

  // Visual chassis
  let chassisGeo = new THREE.BoxGeometry(2, 1, 4);
  let chassisMat = new THREE.MeshStandardMaterial({ color: 0xffff00 });
  chassisMesh = new THREE.Mesh(chassisGeo, chassisMat);
  scene.add(chassisMesh);

  // Vehicle wheels - simple spheres for demo
  let wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.2, 16);
  let wheelMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
  for (let i = 0; i < 4; i++) {
    let wheelMesh = new THREE.Mesh(wheelGeo, wheelMat);
    wheelMesh.rotation.z = Math.PI / 2;
    scene.add(wheelMesh);
    wheelMeshes.push(wheelMesh);
  }

  // Add controls
  window.addEventListener('keydown', keydown);
  window.addEventListener('keyup', keyup);

  // Set up simple vehicle physics later or just move chassis for demo
}

let controls = {
  forward: false,
  backward: false,
  left: false,
  right: false,
};

function keydown(e) {
  switch (e.code) {
    case 'ArrowUp': controls.forward = true; break;
    case 'ArrowDown': controls.backward = true; break;
    case 'ArrowLeft': controls.left = true; break;
    case 'ArrowRight': controls.right = true; break;
  }
}

function keyup(e) {
  switch (e.code) {
    case 'ArrowUp': controls.forward = false; break;
    case 'ArrowDown': controls.backward = false; break;
    case 'ArrowLeft': controls.left = false; break;
    case 'ArrowRight': controls.right = false; break;
  }
}

function animate() {
  requestAnimationFrame(animate);
  let dt = clock.getDelta();

  // Simple manual physics
  let velocity = new CANNON.Vec3();

  if (controls.forward) velocity.z -= 5;
  if (controls.backward) velocity.z += 5;
  if (controls.left) vehicleBody.quaternion.setFromEuler(0, vehicleBody.quaternion.toEuler().y + dt * 2, 0);
  if (controls.right) vehicleBody.quaternion.setFromEuler(0, vehicleBody.quaternion.toEuler().y - dt * 2, 0);

  vehicleBody.velocity.x = velocity.x;
  vehicleBody.velocity.z = velocity.z;

  world.step(dt);

  // Update visuals
  chassisMesh.position.copy(vehicleBody.position);
  chassisMesh.quaternion.copy(vehicleBody.quaternion);

  // Update wheels position roughly
  let wheelPositions = [
    new THREE.Vector3(-1, -0.5, 1.5),
    new THREE.Vector3(1, -0.5, 1.5),
    new THREE.Vector3(-1, -0.5, -1.5),
    new THREE.Vector3(1, -0.5, -1.5),
  ];
  for (let i = 0; i < 4; i++) {
    wheelMeshes[i].position.copy(chassisMesh.position).add(wheelPositions[i]);
    wheelMeshes[i].quaternion.copy(chassisMesh.quaternion);
  }

  // Camera follows vehicle
  let camOffset = new THREE.Vector3(0, 5, 10).applyQuaternion(chassisMesh.quaternion);
  camera.position.copy(chassisMesh.position).add(camOffset);
  camera.lookAt(chassisMesh.position);

  renderer.render(scene, camera);
}
</script>
</body>
</html>
